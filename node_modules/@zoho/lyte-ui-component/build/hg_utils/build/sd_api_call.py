import requests,sys

from email.MIMEMultipart import MIMEMultipart
from email.MIMEText import MIMEText
import smtplib


def sendmail(mailFrom,mailSub,toUsers,ccUsers,htmlStr):
    mailTo=[]
    mailTo.append(toUsers)
    mailTo.append(ccUsers)
    msg=MIMEMultipart('alternative')
    msg['SUBJECT']=mailSub
    msg['TO']=toUsers
    msg['Cc']=ccUsers
    part2 = MIMEText(htmlStr, 'html')
    msg.attach(part2)
    s=smtplib.SMTP('127.0.0.1')
    try:
        s.sendmail(mailFrom,mailTo,msg.as_string())
    except:
        print "Error Occured in sending mail"
    s.quit()

try:
        URL = "https://sd.csez.zohocorpin.com/api/startupgrade"
        AUTHTOKEN = sys.argv[1]
        BUILD_URL = sys.argv[2]
        PRODUCT_NAME = sys.argv[3]
        BTYPE = sys.argv[4]
        PRDNAME_PRDID = sys.argv[5]
        TOUSERS = sys.argv[6]

        PARAMS = {'authtoken':AUTHTOKEN, 'product':PRODUCT_NAME,'bType':BTYPE, 'buildUrl':BUILD_URL, 'retry':1 }

        resp = requests.get(url = URL, params = PARAMS)

        mailFrom='integration-team@zohocorp.com'
        mailSub="SD api call response : " + PRDNAME_PRDID
        toUsers=TOUSERS
        ccUsers='karthiga.c@zohocorp.com,petchimuthu@zohocorp.com'
        mailcontent=resp.content
        if "failure" in mailcontent:
            print mailcontent
            sendmail(mailFrom,mailSub,toUsers,ccUsers,mailcontent)

except:
         print("Argument wrongly passed ...")

