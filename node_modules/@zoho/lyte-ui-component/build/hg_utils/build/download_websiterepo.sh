main()
{
        MOD_NAME=$1
        . /zoho/build/downloads/.env.conf
        echo "Ping cmtools before API execution"
        timeout 2 ping cmtools.csez.zohocorpin.com
        ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
        echo "Ping cmtools after API execution"
        timeout 2 ping cmtools.csez.zohocorpin.com
        if [ -z "${ACCESS_VALUE}" ]
        then
              echo "Access Value is empty so waiting and retry will happen"
              sleep 10
              ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
              if [ -z "${ACCESS_VALUE}" ]
              then
                 echo "Access Value is empty so waiting and retry happened 2nd time"
                 sleep 10
                 ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
              fi
              if [ -z "${ACCESS_VALUE}" ]
              then
                 echo "Access Value is empty so waiting and retry happened 3rd time"
                 sleep 10
                 ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" http://integrepo-secondary:8081/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
              fi
        fi
        export ACCESS_VALUE
        ACCESS_VALUE=`echo $ACCESS_VALUE | sed -e 's/"//g'`
        export ACCESS_VALUE
        if [ ${MOD_NAME} == "desktop-central" ]
        then
             wget --tries=2 --header='Authorization:Zoho-oauthtoken '${ACCESS_VALUE} --header='X-ZR-Email:cjayaprakash@zohocorp.com' https://repository.zoho.com/repos/4000002181155/api/v1/archive/master/desktop-central-master.zip --no-check-certificate
             ZREPO_ZIP_CHK=`zip -T "desktop-central-master.zip" | grep "OK"`
             ZREPO_ZIP_CHK_STATUS=`echo $?`
             echo "Zip Check Status --> ${ZREPO_ZIP_CHK_STATUS}"
             if [ -f "desktop-central-master.zip" -a ${ZREPO_ZIP_CHK_STATUS} -eq 0 ]
             then
                  unzip desktop-central-master.zip
                  mv desktop-central-master desktop-central
                  rm -f desktop-central-master.zip
             else
                ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
                if [ -z "${ACCESS_VALUE}" ]
                then
                     echo "Access Value is empty so waiting and retry will happen"
                     sleep 10
                     ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
                     if [ -z "${ACCESS_VALUE}" ]
                     then
                         echo "Access Value is empty so waiting and retry happened 2nd time"
                         sleep 10
                         ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
                     fi
                     if [ -z "${ACCESS_VALUE}" ]
                     then
                         echo "Access Value is empty so waiting and retry happened 3rd time"
                         sleep 10
                        ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" http://integrepo-secondary:8081/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
                     fi
                fi
                export ACCESS_VALUE
                ACCESS_VALUE=`echo $ACCESS_VALUE | sed -e 's/"//g'`
                export ACCESS_VALUE
                git clone --recursive -b master https://Zoho-oauthtoken:${ACCESS_VALUE}@zrepository.zoho.com/zohocorp/webmaster/manageengine/products/desktop-central.git
             fi
        elif [ ${MOD_NAME} == "desktop-management-msp" ]
        then
             ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
             if [ -z "${ACCESS_VALUE}" ]
             then
                  echo "Access Value is empty so waiting and retry will happen"
                  sleep 10
                  ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
                  if [ -z "${ACCESS_VALUE}" ]
                  then
                         echo "Access Value is empty so waiting and retry happened 2nd time"
                         sleep 10
                         ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
                  fi
                  if [ -z "${ACCESS_VALUE}" ]
                  then
                       echo "Access Value is empty so waiting and retry happened 3rd time"
                       sleep 10
                       ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" http://integrepo-secondary:8081/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
                   fi
             fi
             export ACCESS_VALUE
             ACCESS_VALUE=`echo $ACCESS_VALUE | sed -e 's/"//g'`
             export ACCESS_VALUE
             wget --tries=2 --header='Authorization:Zoho-oauthtoken '${ACCESS_VALUE} --header='X-ZR-Email:cjayaprakash@zohocorp.com' https://repository.zoho.com/repos/4000002182777/api/v1/archive/master/desktop-management-msp-master.zip --no-check-certificate
             ZREPO_ZIP_CHK=`zip -T "desktop-management-msp-master.zip" | grep "OK"`
             ZREPO_ZIP_CHK_STATUS=`echo $?`
             echo "Zip Check Status --> ${ZREPO_ZIP_CHK_STATUS}"
             if [ -f "desktop-management-msp-master.zip" -a ${ZREPO_ZIP_CHK_STATUS} -eq 0 ]
             then
                  unzip desktop-management-msp-master.zip
                  mv desktop-management-msp-master desktop-management-msp
                  rm -f desktop-management-msp-master.zip
             else
                 ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
                if [ -z "${ACCESS_VALUE}" ]
                then
                    echo "Access Value is empty so waiting and retry will happen"
                    sleep 10
                    ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
                    if [ -z "${ACCESS_VALUE}" ]
                    then
                         echo "Access Value is empty so waiting and retry happened 2nd time"
                         sleep 10
                         ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" https://cmtools.csez.zohocorpin.com/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
                    fi
                    if [ -z "${ACCESS_VALUE}" ]
                    then
                          echo "Access Value is empty so waiting and retry happened 3rd time"
                          sleep 10
                          ACCESS_VALUE=`curl -X GET -H "PRIVATE-TOKEN:${PRIVATE_TOKEN}" http://integrepo-secondary:8081/api/v1/get_service_access_tokens?service_name=ZCloudRepo`
                    fi
                fi
                export ACCESS_VALUE
                ACCESS_VALUE=`echo $ACCESS_VALUE | sed -e 's/"//g'`
                export ACCESS_VALUE
                 git clone --recursive -b master https://Zoho-oauthtoken:${ACCESS_VALUE}@zrepository.zoho.com/zohocorp/webmaster/manageengine/desktop-management-msp.git
             fi
        fi
}
main $*
