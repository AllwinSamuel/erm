TriggerDepBuilds()
{
resolveBuildVariables $*
resolveTeamSpecificInfo
TriggerDependencyBuilds
}

resolveBuildVariables()
{
        CMTOOLS_API_URL="https://cmtools.csez.zohocorpin.com/api/v1"
        BUILDLOGS_API_URL="$CMTOOLS_API_URL/buildlogs"
    
        DEPENDENCY_BUILDS="${DEP_BUILDS}"
        echo ${DEPENDENCY_BUILDS}
        for dep_bld in `echo ${DEP_BUILDS} | tr "," " "`
        do
                dep_name=`echo ${dep_bld} | cut -d "=" -f1 | cut -d ":" -f1`
                dep_prdId=`echo ${dep_bld} | cut -d "=" -f1 | cut -d ":" -f2`
                dep_val=`echo ${dep_bld} | cut -d "=" -f2`
                depBldUrl=`echo ${dep_val} | grep -E "(http://|https://)"`
                depUrlOut=`echo $?`
                if [ "${dep_val}" != "DEFAULT" ]
                then
                        if [ ${depUrlOut} -ne 0 ]
                        then
                                export ${dep_name}_BRANCH=${dep_val}
                        else
                                log_message "$dep_name  have the value http://"
                                export ${dep_name}=${dep_val}
                                if [ -n "${prev_dep_build}" ]
                                then
                                    previousDepBldId=$prev_dep_build,\"${dep_prdId}\":\"${dep_val}\"
                                    prev_dep_build=`echo $previousDepBldId | sed "s/^,/{/g" | sed "s/$/}/g" | sed "s/},/,/g"`
                                    export prev_dep_build
                                    log_message ${prev_dep_build}
                                else
                                    prev_dep_build="{\"${dep_prdId}\":\"${dep_val}\"}"
                                    log_message "${dep_name} : ${dep_val}"
                                fi
                        fi
                fi
        done
}

resolveTeamSpecificInfo()
{
        if [ ! -z "${TEAM_SPECIFIC_INFO}" ]
        then
                for i in `echo "${TEAM_SPECIFIC_INFO}" | tr "," " "`
                do
                        export "$i"
                done
        fi
        if [ ! -z "${PATCH_BUILD_CHANGESET}" -a "${PATCH_BUILD_CHANGESET}" != "NA" ]
        then
                export TIP_CHANGESET=${PATCH_BUILD_CHANGESET}
                sed -i "s@TIP_CHANGESET=\(.*\)@TIP_CHANGESET=\"${TIP_CHANGESET}\"@g" ${build_info_file}

        fi

}

TriggerDependencyBuilds()
{
   
    ##DEP_BUILDS="${DEPENDENCY_BUILDS}"
        TriggerCoreLibBuild & 
        TriggerCrmEmailBuild &
	if [ ${ARG} != "ZOHOCRM_BUILD_TIME_REDUCTION_2_BRANCH" ]
        then
        {
                TriggerCrmLyteBuild &
        }
        fi

        export DEP_BUILDS="${DEPENDENCY_BUILDS}"


}
TriggerCrmEmailBuild()
{
   if [ -n "${CRMEMAIL_BRANCH}" ]
   then
        curl -k -X POST -H "Content-Type: application/json" -H "PRIVATE-TOKEN: ${PRIVATE_TOKEN}" --data '{ "product_id":"'2240'", "checkout_label":"'"${CRMEMAIL_BRANCH}"'", "build_type":"'"${BUILD_TYPE}"'", "report_need":"false", "status":"Start", "started_from":"Webhost", "comment":"'"${WH_BUILD_ID}"'", "started_by_user":"'"${BUILDBY}"'", "success_mail":"'"${SUCCESS_MAIL_ID}"'","error_mail":"'"${ERROR_MAIL_ID}"'", "static_version":"'"${STATIC_DIRNAME}"'", "dependency_builds":'${prev_dep_build}',"instant_response":"true" }' ${BUILDLOGS_API_URL} &
        
       echo "CRMEMAIL:2240" >> ${WORK_DIR}/paralleltriggered_builds.txt
       echo "CRMEMAIL::" >> ${WORK_DIR}/dependency.txt
       getDependentBuildStatus "CRMEMAIL" "2240"
   else
       log_message "CRMEMAIL BUILD URL PASSED. HENCE, BUILD IS NOT TRIGGERED."
   fi
}

TriggerCoreLibBuild()
{
   if [ -n "${CORE_LIBRARY_BRANCH}" ]
   then
        echo "core library build started."
        curl -k -X POST -H "Content-Type: application/json" -H "PRIVATE-TOKEN: ${PRIVATE_TOKEN}" --data '{ "product_id":"'6805'", "checkout_label":"'"${CORE_LIBRARY_BRANCH}"'", "build_type":"'"${BUILD_TYPE}"'", "report_need":"false", "status":"Start", "started_from":"Webhost", "comment":"'"${WH_BUILD_ID}"'", "started_by_user":"'"${BUILDBY}"'", "success_mail":"'"${SUCCESS_MAIL_ID}"'","error_mail":"'"${ERROR_MAIL_ID}"'", "static_version":"'"${STATIC_DIRNAME}"'", "dependency_builds":'${prev_dep_build}',"instant_response":"true" }' ${BUILDLOGS_API_URL} &

       echo "CORE_LIBRARY:6805" >> ${WORK_DIR}/paralleltriggered_builds.txt
       echo "CORE_LIBRARY::" >> ${WORK_DIR}/dependency.txt
       getDependentBuildStatus "CORE_LIBRARY" "6805"
        echo "core library build ended."
   else
       log_message "CORE_LIBRARY BUILD URL PASSED. HENCE, BUILD IS NOT TRIGGERED."
   fi
}


TriggerCrmLyteBuild()
{
    log_message "crmlyte_build_gen started"
    
    CRM_LYTE_DOWNLOAD_PATH="/zoho/build/downloads/dload/zoho/zohocrm_lyte/${ARG}"
    CRM_LYTE_DOWNLOAD_TXT_PATH="/zoho/build/downloads/dload/zoho/zohocrm_lyte/${ARG}/logs/ZOHOCRM_LYTE.txt"
    if [ ! -d ${CRM_LYTE_DOWNLOAD_PATH} ]
    then
        
        cmtools_domain_name="https://cmtools.csez.zohocorpin.com"
        log_message "zohocrm_Lyte branch build is not available, so webhost build trigger via cmtools API"
        TRIGER_BUILD="YES"
        export TRIGER_BUILD
        getDependentBuildStatus_lyte "ZOHOCRM_LYTE" 4752 "${WH_BUILD_ID}" 58 
    
    elif [ ! -s ${CRM_LYTE_DOWNLOAD_TXT_PATH} ]
    then
	
        log_message "file is empty"
     	cmtools_domain_name="https://cmtools.csez.zohocorpin.com"
        log_message "zohocrm_Lyte branch build is not available, so webhost build trigger via cmtools API"
        TRIGER_BUILD="YES"
        export TRIGER_BUILD
        getDependentBuildStatus_lyte "ZOHOCRM_LYTE" 4752 "${WH_BUILD_ID}" 58

    else
        if [ "${BUILD_FOR}" = "RELEASE" ]
	then
                cmtools_domain_name="https://cmtools.csez.zohocorpin.com"
        	log_message "RELEASE build so lyte build triggered by default."
                TRIGER_BUILD="YES"
                export TRIGER_BUILD
                getDependentBuildStatus_lyte "ZOHOCRM_LYTE" 4752 "${WH_BUILD_ID}" 58
    	else

            log_message "crm_lyte build already available ."
            pre_lyte_changeset=`cat /zoho/build/downloads/dload/zoho/zohocrm_lyte/${ARG}/logs/ZOHOCRM_LYTE.txt | grep "TIP_SUB_PRODUCT_DETAILS" |cut -d "=" -f3 | cut -d ":" -f6`
	    if [ ! -z $pre_lyte_changeset ]
	    then
	        log_message "TIP_SUB_PRODUCT_DETAILS val not empty"
		getDependentBuildStatus_lyte "ZOHOCRM_LYTE" 4752 "${WH_BUILD_ID}" 58 "${pre_lyte_changeset}"

            else
                log_message "TIP_SUB_PRODUCT_DETAILS val is empty"
		cmtools_domain_name="https://cmtools.csez.zohocorpin.com"
	        log_message "zohocrm_Lyte branch builds tip sub changeset not available , so webhost build trigger via cmtools API"
        	TRIGER_BUILD="YES"
        	export TRIGER_BUILD
		getDependentBuildStatus_lyte "ZOHOCRM_LYTE" 4752 "${WH_BUILD_ID}" 58

             fi

        fi
    fi
        log_message "crmlyte_build_gen ended"

}


getDependentBuildStatus_lyte()
{
        log_message "getDependentBuildStatus started"
        sec_build_prdName=$1
        sec_prod_id=$2
        primary_build_id=$3
        primary_prod_id=$4
        pre_lyte_build_changeset=$5

        log_message "getModifiedsource_api calling"
        API="${cmtools_domain_name}/api/v1/repo/get_build_diff?"
        PARAMS="repo_link=${CLONE_VALUE}&revision1=${pre_lyte_build_changeset}&revision2=${TIP_CHANGESET}&files_only=true"
        PARAMS_VAL="repo_link=${CLONE_VALUE}&revision1=${pre_lyte_build_changeset}&revision2=${TIP_CHANGESET}&files_only=true"
        mod_src_files=` curl -k -X GET -H "PRIVATE-TOKEN: ${PRIVATE_TOKEN}" "${API}${PARAMS}"`

        log_message "${API}${PARAMS_VAL}"
        modified_src_files=`echo $mod_src_files | cut -d ":" -f2  | sed 's/[\[\]//' |  sed 's/[\"]\]/"/' |  sed 's/[\}\]//'`
        log_message "Modified Source Files $modified_src_files"
        lyte_webapps=`echo $modified_src_files | grep -Ew "(webapps/zohocrm/CRMClient|webapps/zohocrm/css/style|webapps/zohocrm/css/lessconfig|webapps/zohocrm/CRMOrganization)"`
        if [ ! -z $lyte_webapps ]
        then
                log_message "Get_Dep_Build_changeset: ${pre_lyte_build_changeset}"
                getDeptip_changeset_val="${TIP_CHANGESET}"
                log_message "Get_Dep_Repo_changset: ${getDeptip_changeset_val}"
                if [ "${pre_lyte_build_changeset}" != "${getDeptip_changeset_val}" ]
                then
                        TRIGER_BUILD="YES"
                        export TRIGER_BUILD
                else
                        log_message "Previous build and repo current tip changeset source are doesn't contain crmClient so build not triggered."
                fi

        fi

        log_message "TRIGER_BUILD=${TRIGER_BUILD}"

        if [ "${TRIGER_BUILD}" = "YES" ]
        then

                curl -k -X GET --header "PRIVATE-TOKEN: ${GIT_WGET_PRIVATE_TOKEN}" "https://zgit.csez.zohocorpin.com/api/v4/projects/CRM%2Fzohocrm/repository/files/build%2Fant.properties/raw?ref=${ARG}" >> ${WORK_DIR}/crm_ant.properties
                LYTE_IMAGE=`cat ${WORK_DIR}/crm_ant.properties | grep "lyte_cli_image_path" | cut -d "=" -f2`
                log_message ${LYTE_IMAGE}
                
                curl -k -X POST -H "Content-Type: application/json" -H "PRIVATE-TOKEN: ${PRIVATE_TOKEN}" --data '{ "product_id":"4752", "checkout_label":"main", "build_type":"FULLBUILD", "report_need":"false", "status":"Start", "started_from":"Webhost", "comment":"'"${WH_BUILD_ID}"'", "started_by_user":"'"${BUILDBY}"'", "success_mail":"'"${SUCCESS_MAIL_ID}"'","error_mail":"'"${ERROR_MAIL_ID}"'", "static_version":"NA", "dependency_builds":"", "customize_info":"LYTE_IMAGE_NAME='"${LYTE_IMAGE}"'","subproduct_labels":{"'"${primary_prod_id}"'":"'"${ARG}"'"},"instant_response":"true" }' ${cmtools_domain_name}/api/v1/buildlogs
                
                cmtools_posturl_status=$(echo $?)
                log_message "CMTools Post URL Status $cmtools_posturl_status"
                if [ ${cmtools_posturl_status} -ne 0 ]
                then
                        log_message "cmtools_posturl_call failed with ${cmtools_posturl_status}, retry call added."
                        curl -k -X POST -H "Content-Type: application/json" -H "PRIVATE-TOKEN: ${PRIVATE_TOKEN}" --data '{ "product_id":"4752", "checkout_label":"main", "build_type":"FULLBUILD", "report_need":"false", "status":"Start", "started_from":"Webhost", "comment":"'"${WH_BUILD_ID}"'", "started_by_user":"'"${BUILDBY}"'", "success_mail":"'"${SUCCESS_MAIL_ID}"'","error_mail":"'"${ERROR_MAIL_ID}"'", "static_version":"NA", "dependency_builds":"", "customize_info":"LYTE_IMAGE_NAME='"${LYTE_IMAGE}"'","subproduct_labels":{"'"${primary_prod_id}"'":"'"${ARG}"'"},"instant_response":"true" }' ${cmtools_domain_name}/api/v1/buildlogs
                
                fi


                echo "ZOHOCRM_LYTE:4752" >> ${WORK_DIR}/paralleltriggered_builds.txt
                echo "ZOHOCRM_LYTE::" >> ${WORK_DIR}/dependency.txt
                
                getDependentBuildStatus "ZOHOCRM_LYTE" "4752"
        fi
        log_message "getDependentBuildStatus ended"
}


getDependentBuildStatus()
{
    checkDependentBuildStatus ${1} ${2}
}
