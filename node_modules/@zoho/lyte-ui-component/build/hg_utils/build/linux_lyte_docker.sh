basedir=`dirname $1`
input_zipname=`basename $1`
BUILD_ID=$2
zipname=$3
lyte_image_name=$4
lyte_loc_needed=$5
lyte_npminstall_needed=$6
lyte_dir=`echo $input_zipname | cut -d "." -f1`
cd ${basedir}
unzip ${basedir}/${input_zipname} -d ${lyte_dir}

echo $lyte_image_name | grep -w "slyte"
image_name_st=$?
if [ "$image_name_st" -ne 0 ]
then
        lyte_command=/usr/local/bin/lyte
else
        lyte_command=/usr/local/bin/slyte
fi

echo "lyte_command: $lyte_command"
echo "lyte_image_name: $lyte_image_name"

sudo docker pull ${lyte_image_name}

lyte_authtoken()
{
        sudo docker run  -t ${lyte_image_name} ls /node_modules/lyte-cli/lib/utilities/authToken.json
        if [ $? -eq 0 ]
        then
                LYTE_OPTS=" -v ${basedir}/lyte_authtoken.json:/node_modules/lyte-cli/lib/utilities/authToken.json "
        fi

}

copylytelogs(){
   echo "copying lyte logs"
   fileList=`find . -iname "log.txt" | tr '\n' ' '`
   for file in `echo ${fileList} | tr "," " " | sed -e "s@\"@@g"`; do
   file_dirname="`basename $(dirname ${file})`"
   file_name="`basename ${file}`"
   mkdir -p "lytelogs/$file_dirname"
   cp -fv  $file lytelogs/$file_dirname
   done
   zip -r lytelogs.zip lytelogs/
}

if [ "${lyte_npminstall_needed}" == "yes" -a "$lyte_loc_needed" == "yes" ]
then
        lyte_authtoken
        sudo docker run -t --name=${BUILD_ID}_$RANDOM -v ${basedir}:${basedir} -w=${basedir}/${lyte_dir} ${LYTE_OPTS} ${lyte_image_name}  /usr/local/bin/npm install --registry http://cm-npmregistry/
        sudo docker run -t --name=${BUILD_ID}_$RANDOM -v ${basedir}:${basedir} -w=${basedir}/${lyte_dir} ${LYTE_OPTS} ${lyte_image_name}  ${lyte_command} loc

elif [ "$lyte_loc_needed" == "yes" ]
then
        lyte_authtoken
        sudo docker run -t  --name=${BUILD_ID}_$RANDOM -v ${basedir}:${basedir} -w=${basedir}/${lyte_dir} ${LYTE_OPTS} ${lyte_image_name} ${lyte_command} loc
fi

sudo docker run  --name=${BUILD_ID}_$RANDOM -v ${basedir}:${basedir} ${LYTE_OPTS} -w=${basedir}/${lyte_dir} ${lyte_image_name} ${lyte_command} build --globalCli --production
docker_status=$?
copylytelogs
if [ $docker_status -ne 0 ]
then
        echo "lyte failed"
        exit 1
fi

if [ ! -z "$5" ]
then
        if [ "$5" != "yes" ]
        then
                lyte_op_dir="${basedir}/${lyte_dir}/$5"
                cd ${lyte_op_dir}
               
		if [ -d dist ]
                then
                        zip -r $zipname dist
                else
                        zip -r $zipname .
                fi

                cp -rf ${lyte_op_dir}/$zipname  ${basedir}/${lyte_dir}/
        else
                lyte_op_dir=${basedir}/${lyte_dir}
                cd $lyte_op_dir
                
		if [ -d dist ]
                then
                        zip -r $zipname dist
                else
                        zip -r $zipname .
                fi

        fi
else
                lyte_op_dir=${basedir}/${lyte_dir}
                cd $lyte_op_dir
                zip -r $zipname dist
fi
