#!/bin/sh
[ $3 ] || { echo "Usage: $0 <7zSFX_FOLDER> <SOURCE_FOLDER> <DESTINATION_FILE_PATH>"; exit 1; }
main()
{
    sfx_folder=$1
    sfx_filepath="${sfx_folder}/7zCon.sfx"
    source_folder=$2
    destination_path=$3
    folder_err_msg="is not available!!.. Kindly make it available..."
    resolveVariables
    create7zsfx
}
resolveVariables()
{
    if [ ! -d "${sfx_folder}" ]; then
        echo "${sfx_folder} ${folder_err_msg}"
	exit 1
    else
        if [ -f "${sfx_filepath}" ]; then
            echo "7zCon.sfx availability check done!!."
	else
            echo "7zCon.sfx is not available under ${sfx_folder} !!."
	    exit 1
	fi
    fi

    if [ ! -d "${source_folder}" ]; then
        echo "${source_folder} ${folder_err_msg}"
	exit 1
    fi

    destPath_extn=$(echo ${destination_path##*.})
    if [ "${destPath_extn}" != "exe" ]; then
        echo "Output file path should be an .exe format !!.."
	exit 1
    else
        output_filename=$(basename ${destination_path})
	temp_7zfilename=$(echo ${output_filename} | cut -d "." -f1)
	output_foldername=$(echo ${destination_path} | rev | cut -d "/" -f2- | rev)
	if [ ! -d ${output_foldername} ]; then
		mkdir -p ${output_foldername}
		echo "output directory created :: ${output_foldername}"
	fi
    fi

}
create7zsfx()
{
	parent_src_folder=$(echo ${source_folder} | rev | cut -d "/" -f2- | rev)
	src_folder=$(echo ${source_folder} | rev | cut -d "/" -f1 | rev)
	cd ${parent_src_folder}
	if [ -d "${src_folder}" ]; then
	    echo "7z creation started.."
	    7z a -mx=9 ${temp_7zfilename}.7z ${src_folder}
	    if [ $? -eq 0 ]; then
                cat ${sfx_filepath} ${temp_7zfilename}.7z > ${destination_path}
		if [ $? -eq 0 ]; then
			echo "${destination_path} successfully generated !!.."
		else
			echo "${destination_path} generation failed.."
			exit 1
		fi
	    else
		    echo "${temp_7zfilename}.7z generation failed.."
		    exit 1
	    fi
	fi
}
main $*
