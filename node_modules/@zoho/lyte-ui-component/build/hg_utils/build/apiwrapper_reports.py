#! /usr/bin/python
from clonehook import *
import sys, logging
import time, smtplib
from email.MIMEMultipart import MIMEMultipart
from email.MIMEText import MIMEText
from datetime import datetime

def sendmail(to,sub,response):
        TO = to
        SUBJECT = sub
        html="<h3> Failure Notification in build reports copy </h3><br>\t1.\t Get milestone moved status return started .<br><br>. Cmtools API Response : <br><pre>" + str(response) + "</pre>  Thanks,<br>Integration-Team"
        msg=MIMEMultipart('alternative')
        msg.set_charset('utf8')
        msg['Subject']=SUBJECT
        msg['From']='integration-team@zohocorp.com'
        msg['To'] = to
        part2 = MIMEText(html.encode('utf-8'), 'html', 'UTF-8')
        msg.attach(part2)
        s=smtplib.SMTP('smtp.csez.zohocorpin.com')
        s.sendmail("integration-team@zohocorp.com",TO,msg.as_string())
        s.quit()

def gettime():
    now = datetime.now()
    date = now.strftime("%H:%M:%S:%f")
    return date

classObject = updateTime("GET")
bldId = None 
if len(sys.argv) == 2:
        bldId = sys.argv[1]
        milestoneMovedStatus = classObject.getmilestonemovedstatus(bldId)
        cmtools_api_response_Movedststus = ""
        starting_time = ""
        logging.warning("Initial Response : " + str(milestoneMovedStatus))
        if milestoneMovedStatus == None:
                print ("Webhost build")
        elif milestoneMovedStatus[0]['status'] == "Started":
                retry = 1
                while (retry <= 3):
                    time.sleep(60)
                    logging.warning("Inside while loop " + str(retry))
                    retry_cnt = str(retry) 
                    milestoneMovedStatus = classObject.getmilestonemovedstatus(bldId)
                    logging.warning("Inside While loop response " + str(milestoneMovedStatus))
                    cmtools_api_response_Movedststus += "Retry count :"+ str (retry) + " Response : " + str(milestoneMovedStatus) +" time: "+str (gettime()) +"<br><br>"
                    if str(milestoneMovedStatus[0]['status']) == "Started":
                        retry += 1
                    elif str(milestoneMovedStatus[0]['status']) == "Success":
                        break;
                else:
                    logging.error("retry count " + str(retry) + " exceeded the max limit. Hence, the reports copy process quitted.")

                    sub = "CMTools Api failed to get milestone moved details for the Build ID : "+str(bldId)
                    response = cmtools_api_response_Movedststus
                    sendmail('integration-team@zohocorp.com', sub, response)
                    sys.exit(1)

        milestoneMovedDet = classObject.getmilestonemoveddetails(bldId)
        if milestoneMovedStatus != None:
            print (milestoneMovedDet)
else:
        logging.error("python apiwrapper_reports.py <ARGS>")
        sys.exit(1)
