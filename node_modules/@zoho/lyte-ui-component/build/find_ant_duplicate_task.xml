<?xml version="1.0"?>
<project xmlns:props="antlib:org.apache.ant.props" name="build" default="gettarget" basedir=".">
  <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
  <property environment="env"/>
  <property name="alltaskname" value="${basedir}/alltaskname.txt"/>
  <property name="ant_duplicate_task_file" value="${basedir}/duplicate_task_list.txt"/>
  <loadfile srcfile="ant.properties" property="load_properties_file">
    <filterchain>
      <linecontainsregexp>
        <regexp pattern="^load_properties_file"/>
      </linecontainsregexp>
      <tokenfilter>
        <replacestring from="load_properties_file=" to=""/>
      </tokenfilter>
      <striplinebreaks/>
    </filterchain>
  </loadfile>
  <if>
    <isset property="load_properties_file"/>
    <then>
      <for list="${load_properties_file}" param="fileline">
        <sequential>
          <if>
            <available file="@{fileline}" type="file"/>
            <then>
              <property file="@{fileline}"/>
            </then>
          </if>
        </sequential>
      </for>
    </then>
  </if>
  <property environment="env"/>
  <if>
    <available file="${env.ANT_HOME}/lib/ant-props.jar" type="file"/>
    <then>
      <typedef resource="org/apache/ant/props/antlib.xml" classpath="${env.ANT_HOME}/lib/ant-props.jar"/>
      <propertyhelper>
        <props:nested/>
      </propertyhelper>
    </then>
    <else>
      <echo message="${env.ANT_HOME}/lib/ant-props.jar is not available ."/>
    </else>
  </if>
  <if>
    <not>
      <isset property="trim_val"/>
    </not>
    <then>
      <loadfile property="trim_val" srcfile="ant.properties">
        <filterchain>
          <trim/>
        </filterchain>
      </loadfile>
      <echo message="${trim_val}" file="ant.properties"/>
    </then>
  </if>
  <property file="ant.properties"/>
  <!-- Get Target Order -->
  <target name="gettarget">
    <if>
      <available file="${alltaskname}" type="file"/>
      <then>
        <delete file="${alltaskname}"/>
      </then>
    </if>
    <if>
      <isset property="target"/>
      <then>
        <propertycopy name="build_order" from="${target}_order" silent="true"/>
        <property name="targetname" value="${target}"/>
      </then>
      <else>
        <propertycopy name="build_order" from="local_order" silent="true"/>
        <property name="targetname" value="local"/>
      </else>
    </if>
    <echo message="calltarget :${targetname}"/>
    <echo message="target order:${build_order}"/>
    <foreach list="${build_order}" target="calltarget" inheritall="true" param="prop">
	  </foreach>
    <if>
      <available file="${alltaskname}" type="file"/>
      <then>
        <echo message="cat ${alltaskname} | sort | uniq -d &gt; ${ant_duplicate_task_file}" file="/tmp/find_duplicate.sh" append="false"/>
        <if>
          <available file="/tmp/find_duplicate.sh" type="file"/>
          <then>
            <exec dir="${basedir}" executable="/bin/sh" resultproperty="exitValue">
              <arg line="/tmp/find_duplicate.sh"/>
            </exec>
          </then>
        </if>
      </then>
    </if>
  </target>
  <!-- Get Main Order -->
  <target name="calltarget">
    <propertycopy name="call" from="${prop}_order"/>
    <propertycopy name="call_needed" from="${prop}_needed" silent="true"/>
    <if>
      <equals arg1="${call_needed}" arg2="no"/>
      <then>
        <echo message="value of ${prop}_needed is No. So ${prop}_order has to be quited"/>
      </then>
      <else>
        <foreach list="${call}" target="calltask" inheritall="true" param="prop">
                </foreach>
      </else>
    </if>
  </target>
  <!-- Get Ant Tasks -->
  <target name="calltask">
    <propertyregex property="task" input="${prop}" regexp="(.*):" select="\1" casesensitive="false"/>
    <propertyregex property="param" input="${prop}" regexp=":(.*)" select="\1" casesensitive="false"/>
    <if>
      <equals arg1="${task}" arg2="contextpkgpara"/>
      <then>
        <echo message="${task}:${param}${line.separator}" file="${alltaskname}" append="true"/>
        <propertycopy name="context" from="${param}_contextpkg_context" silent="false"/>
        <for list="${context}" param="ordername">
          <sequential>
            <antcall target="parallelexecution" inheritall="true">
              <param name="ordername" value="@{ordername}"/>
            </antcall>
          </sequential>
        </for>
      </then>
      <else>
        <echo message="${task}:${param}${line.separator}" file="${alltaskname}" append="true"/>
      </else>
    </if>
  </target>
  <!-- CallContextOrder -->
  <target name="parallelexecution">
    <propertycopy name="callorder" from="${ordername}_order"/>
    <propertycopy name="order_ondemand" from="${ordername}_needed" silent="true"/>
    <if>
      <equals arg1="${order_ondemand}" arg2="no"/>
      <then>
        <echo message="Quitting ${ordername}_order as it is not needed"/>
      </then>
      <else>
        <foreach list="${callorder}" target="calltask" inheritall="false" param="prop">

    </foreach>
      </else>
    </if>
  </target>
</project>
