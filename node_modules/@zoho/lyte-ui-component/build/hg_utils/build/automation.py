import requests
import urllib
import json
import os
import datetime
import sys

dtime = datetime.datetime.now()
crtime = dtime.strftime("%H:%M:%S_%b_%d_%Y")
print "\nTime before posting in chat and connect : " + str(crtime) + "\n\n"
#cur_dir = os.getcwd()
#milestone_dir = os.path.dirname(cur_dir)
milestone_dir = sys.argv[1]
branch = sys.argv[2]
connectkey = sys.argv[3]
cliqkey = sys.argv[4]
milestone_name = os.path.basename(milestone_dir)
milestone_url = milestone_dir.replace('/zoho/build/downloads/dload', 'https://build.zohocorp.com')
info = ""
if os.path.exists(milestone_dir + os.sep + 'logs/release_notes.txt'):
    with open(milestone_dir + os.sep + 'logs/release_notes.txt', 'r') as myfile:
        info = myfile.read()
    print "****************************"
    print info
    print "****************************\n\n"
else:
    print milestone_dir + os.sep + "logs/release_notes.txt is not present ..\n"

def test():

    # For posting in connect
    values1 = {}
    values1['payload'] = "{message:"+json.dumps("["+milestone_name+"]("+milestone_url+")\n\n"+info)+"}"
    #url = 'https://connect.zoho.com/webhook/v1/incoming/intranet/105000128771651?zapikey=1001.96ec59d17beb1fb3ff528668361e5591.a8270607ee46027ac9076390cc76825c'
    if branch == "default":
        url = 'https://connect.zoho.com/webhook/v1/incoming/intranet/105000422878666?zapikey='+connectkey
    else:
        url = 'https://connect.zoho.com/webhook/v1/incoming/intranet/105000447010068?zapikey='+connectkey
    headers = {'content-type': 'application/x-www-form-urlencoded'}
    r = requests.post(url, data=values1, headers=headers)
    print "Posted in Test Connect"

    if branch == "default":
        url = 'https://cliq.zoho.com/api/v2/channelsbyname/buildreleasenotification/message?zapikey='+cliqkey
    else:
        url = 'https://cliq.zoho.com/api/v2/channelsbyname/releaseprocesssaslite/message?zapikey='+cliqkey
    msg_template = [{"type": "text", "data": info}]
    custom_sender_name = {"name": "Chatbot"}
    data = {"slides": msg_template, "bot": custom_sender_name, "text": "["+milestone_name+"]("+milestone_url+")"}
    headers = {'content-type': 'application/json'}
    r = requests.post(url, data=json.dumps(data), headers=headers)
    print "Posted in Test Chat"

test()

dtime = datetime.datetime.now()
crttime = dtime.strftime("%H:%M:%S_%b_%d_%Y")
print "\nTime after posting in chat and connect : " + str(crttime) + "\n"
